# Module 1: Booting NetBSD ARM64 System from UEFI

This module demonstrates how to integrate the EDK II firmware (built in Module 0) with the NetBSD distribution (built in the project root). We will utilize the UEFI-ready GPT disk image generated by the NetBSD `build.sh release` process.

## 1. Prepare and Verify the NetBSD ARM64 Disk Image

The NetBSD build system produces a compressed disk image (`arm64.img.gz`) that includes a GPT partition table with an EFI System Partition (ESP) and a FFS root partition.

```bash
# Ensure environment variables are loaded from the project root
# source ./envsetup.sh

cd $LABS_M1_ROOT && \
gunzip -c $LABSROOT/usr/obj/releasedir/evbarm-aarch64/binary/gzimg/arm64.img.gz > netbsd_arm64.img && \
/sbin/sgdisk -p netbsd_arm64.img
```

A valid output should look something like this:

```
Disk netbsd_arm64.img: 2443264 sectors, 1.2 GiB
Sector size (logical): 512 bytes
Disk identifier (GUID): F772076F-E96C-4774-9542-32B1152608AA
Partition table holds up to 16 entries
Main partition table begins at sector 2 and ends at sector 5
First usable sector is 6, last usable sector is 2443258
Partitions will be aligned on 2048-sector boundaries
Total free space is 34805 sectors (17.0 MiB)

Number  Start (sector)    End (sector)  Size       Code  Name
   1           32768          196607   80.0 MiB    EF00  EFI
   2          196608         2441215   1.1 GiB     A902  netbsd-root
```

## 2. Booting the NetBSD ARM64 system with UEFI under QEMU

We use the `virt` machine type and point QEMU to the EDK II firmware (`QEMU_EFI.fd`) as the BIOS. The disk image is attached via `virtio-blk` to ensure high-performance I/O.

```bash
cd $LABS_M1_ROOT && \
qemu-system-aarch64 \
  -M virt \
  -cpu cortex-a57 \
  -m 2G \
  -bios $LABS_M0_ROOT/edk2/Build/ArmVirtQemu-AArch64/DEBUG_GCC5/FV/QEMU_EFI.fd \
  -drive if=none,file=./netbsd_arm64.img,id=hd0,format=raw \
  -device virtio-blk-device,drive=hd0 \
  -object rng-random,filename=/dev/urandom,id=rng0 \
  -device virtio-rng-pci,rng=rng0 \
  -netdev user,id=net0 -device virtio-net-pci,netdev=net0 \
  -nographic \
  -serial pty
```

In this headless QEMU setup, the serial console serves as the primary interface for interacting with both the UEFI boot environment and the NetBSD kernel's console. Attach the serial console by running `screen` such as `screen /dev/pts/3`. Or using `minicom` like `minicom -b 115200 -p /dev/pts/3`.
